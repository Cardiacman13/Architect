#!/usr/bin/env bash

set -euo pipefail
sudo -v

print_colored() {
    local color_code="$1"
    shift
    echo -e "\033[${color_code}m$@\033[0m"
}

print_step() {
    local terminal_width
    terminal_width=$(tput cols)
    local text="$1"
    local text_length=${#text}
    local num_equals
    num_equals=$(((terminal_width - text_length - 2) / 2))
    local equals
    equals=$(printf "%${num_equals}s" | tr ' ' '=')
    print_colored "0;34" "${equals} ${text} ${equals}"
    sleep 1
}

safe_run() {
    if ! "$@"; then
        print_colored "0;31" "Erreur lors de l'exécution de la commande : $*"
        exit 1
    fi
}

safe_append_to_file() {
    local text="$1"
    local file="$2"
    safe_run echo "${text}" | sudo tee -a "${file}" > /dev/null
}

update_system() {
    print_step "Mise à jour du système"
    safe_run sudo pacman -Syu --noconfirm
}

grub=false

check_grub() {
    print_step "Vérification de l'utilisation de GRUB"
    if [[ -f /boot/grub/grub.cfg ]]; then
        grub=true
        safe_run sudo mkdir -p /etc/pacman.d/hooks/
        safe_append_to_file "[Trigger]
        Type = File
        Operation = Install
        Operation = Upgrade
        Operation = Remove
        Target = usr/lib/modules/*/vmlinuz

        [Action]
        Description = Updating grub configuration ...
        When = PostTransaction
        Exec = /usr/bin/grub-mkconfig -o /boot/grub/grub.cfg" "/etc/pacman.d/hooks/100-grub.hook"
    fi
}

optimize_pacman() {
    print_step "Optimisation de pacman"
    safe_run sudo sed -i 's/^#Color/Color/' /etc/pacman.conf
    safe_run sudo sed -i 's/^#VerbosePkgLists/VerbosePkgLists/' /etc/pacman.conf
    safe_run sudo sed -i 's/^#ParallelDownloads = 5/ParallelDownloads = 5/' /etc/pacman.conf
    safe_run sudo sed -i 's/^#IgnorePkg   =/IgnorePkg   = amdvlk lib32-amdvlk/' /etc/pacman.conf
}

install_kernel_headers() {
    print_step "Installation des headers pour les kernels installés"
    for kernel in $(ls /boot | grep vmlinuz); do
        local kernel_name=$(echo $kernel | sed -e 's/vmlinuz-//')
        safe_run sudo pacman -Suy --needed --noconfirm "${kernel_name}-headers"
    done
}

increase_vm_max_map_count() {
    print_step "Augmenter la compatibilité des jeux Windows"
    safe_append_to_file "vm.max_map_count=16777216" "/etc/sysctl.d/99-sysctl.conf"
}

install_yay() {
    print_step "Installation de yay"
    if ! command -v yay &> /dev/null; then
        safe_run sudo pacman -S --needed --noconfirm git base-devel
        safe_run git clone https://aur.archlinux.org/yay-bin.git
        safe_run cd yay-bin
        safe_run makepkg -si --noconfirm
        safe_run cd ..
        safe_run rm -rf yay
    fi
}

configure_maintenance_alias() {
    print_step "Configuration de l'alias de maintenance"
    safe_append_to_file "alias maintenance='sudo pacman -Suy --needed --noconfirm && yay -Suy --needed --noconfirm && flatpak update && fwupdmgr update'" "${HOME}/.bashrc"
}

install_pipewire() {
    print_step "Installation de pipewire"
    safe_run sudo pacman -Rdd --noconfirm pulseaudio jack2 pipewire-media-session
    safe_run sudo pacman -Suy --needed --noconfirm pipewire pipewire-alsa pipewire-jack pipewire-pulse
}

safe_ask() {
    local question="$1"
    local answer
    read -p "${question} (y/n): " answer
    if [[ "${answer}" == "y" ]]; then
        return false
    else
        return true
    fi
}

local nvidia=false
local amd=false
local intel=false

detect_graphics_card() {
    print_step "Détection de la carte graphique"
    if safe_ask "Voulez-vous installer les pilotes NVIDIA ?"; then
        nvidia=true
    fi
    if safe_ask "Voulez-vous installer les pilotes AMD ?"; then
        amd=true
    fi
    if safe_ask "Voulez-vous installer les pilotes Intel ?"; then
        intel=true
    fi
}

install_nvidia_drivers() {
    if [[ "${nvidia}" == true ]]; then
        print_step "Installation des pilotes NVIDIA"
        if [[ "${grub}" == true]]; then
            safe_run sudo sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet"$/GRUB_CMDLINE_LINUX_DEFAULT="loglevel=3 quiet nvidia-drm.modeset=1"/' /etc/default/grub
            safe_run sudo grub-mkconfig -o /boot/grub/grub.cfg
        else
            safe_run sudo find /boot/loader/entries/ -type f -exec sed -i 's/^\(options .*\)$/\1 nvidia-drm.modeset=1/' {} \;
        fi

        print_step "Forcer le chargement des modules NVIDIA"
        if [[ $(lsblk -f | grep / | awk '{print $2}') == "btrfs" ]]; then
            safe_run sudo sed -i 's/MODULES=(btrfs)/MODULES=(btrfs nvidia nvidia_modeset nvidia_uvm nvidia_drm)/' /etc/mkinitcpio.conf
        else
            safe_run sudo sed -i 's/MODULES=()/MODULES=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)/' /etc/mkinitcpio.conf
        fi

        print_step "Installation des pilotes NVIDIA"
        safe_run yay -S --needed --noconfirm nvidia-dkms nvidia-utils lib32-nvidia-utils nvidia-settings vulkan-icd-loader lib32-vulkan-icd-loader cuda

        safe_run sudo mkdir -p /etc/pacman.d/hooks/
        safe_append_to_file "[Trigger]
        Operation=Install
        Operation=Upgrade
        Operation=Remove
        Type=Package
        Target = usr/lib/modules/*/vmlinuz
        Target=nvidia-dkms
        Target=nvidia
        Target=nvidia-lts
        Target=nvidia-dkms
        Target=nvidia-beta
        Target=nvidia-340xx
        Target=nvidia-390xx
        Target=dkms

        [Action]
        Description=Update NVIDIA module in initcpio
        Depends=mkinitcpio
        When=PostTransaction
        NeedsTargets
        Exec=/bin/sh -c 'while read -r trg; do case $trg in linux) exit 0; esac; done; /usr/bin/mkinitcpio -P'" "/etc/pacman.d/hooks/nvidia.hook"
    fi
}

install_amd_drivers() {
    if [[ "${amd}" == true ]]; then
        print_step "Installation des pilotes AMD"
        safe_run yay -S --needed --noconfirm mesa lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader
    fi
}

install_intel_drivers() {
    if [[ "${intel}" == true ]]; then
        print_step "Installation des pilotes Intel"
        safe_run yay -S --needed --noconfirm mesa lib32-mesa vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader
    fi
}

install_fish_shell() {
    print_step "Installation de fish"
    if ! command -v fish &> /dev/null; then
        if safe_ask "Voulez-vous installer fish ?"; then
            safe_run yay -S --needed --noconfirm fish
            safe_run chsh -s /usr/bin/fish
            safe_run fish -c "fish_update_completions; set -U fish_greeting"
        fi
    fi
}

install_essential_packages() {
    print_step "Installation des paquets essentiels"
    safe_run yay -S --needed --noconfirm powerdevil reflector-simple rebuild-detector mkinitcpio-firmware xdg-desktop-portal neofetch power-profiles-daemon hunspell-fr p7zip unrar ttf-liberation noto-fonts noto-fonts-emoji ntfs-3g fuse2 bash-completion xdg-desktop-portal-kde xdg-desktop-portal-gtk okular print-manager gwenview spectacle partitionmanager ffmpegthumbs qt6-wayland kdeplasma-addons vlc
}

install_gamepad_drivers() {
    print_step "Installation des pilotes de manette de jeu"
    if safe_ask "Voulez-vous installer les pilotes de manette de jeu ?"; then
        safe_run yay -S --needed --noconfirm xpadneo-dkms
    fi
}

activate_bluetooth() {
    print_step "Activation du bluetooth"
    if safe_ask "Voulez-vous activer le bluetooth ?"; then
        safe_run yay -S --needed --noconfirm bluez bluez-utils bluez-plugins
        safe_run systemctl enable --now bluetooth.service
    fi
}

install_printer_support() {
    print_step "Installation du support d'imprimante"
    if safe_ask "Voulez-vous installer le support d'imprimante ?"; then
        safe_run yay -S --needed --noconfirm ghostscript gsfonts cups cups-filters cups-pdf system-config-printer avahi
        safe_run sudo systemctl enable --now avahi-daemon
        safe_run systemctl enable --now cups
    fi
}

install_flatpak() {
    print_step "Installation de flatpak"
    if ! command -v flatpak &> /dev/null; then
        safe_run yay -S --needed --noconfirm flatpak flatpak-kcm
        safe_run flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
        flatpak install flathub com.github.tchx84.Flatseal
        flatpak install flathub io.github.giantpinkrobots.flatsweep
    fi
}

install_misc_software() {
    print_step "Installation de logiciels divers"
    if safe_ask "Voulez-vous installer des logiciels divers ?"; then
        safe_ask "Voulez-vous installer Discord ?" && safe_run yay -S --needed --noconfirm discord
        safe_ask "Voulez-vous installer Spotify ?" && safe_run yay -S --needed --noconfirm spotify
        safe_ask "Voulez-vous installer Steam ?" && safe_run yay -S --needed --noconfirm steam
        if safe_ask "Voulez-vous installer Obs ?"; then
            if safe_ask "Voulez-vous installer Obs en flatpak ?"; then
                safe_run flatpak install flathub com.obsproject.Studio
            else
                safe_run yay -S --needed --noconfirm obs-studio
            fi
        fi
        safe_ask "Voulez-vous installer kdenlive ?" && safe_run yay -S --needed --noconfirm kdenlive
        safe_ask "Voulez-vous installer libreoffice ?" && safe_run yay -S --needed --noconfirm libreoffice-fresh libreoffice-fresh-fr
        safe_ask "Voulez-vous installer gimp ?" && safe_run yay -S --needed --noconfirm gimp
}

install_firewall() {
    print_step "Installation du pare-feu"
    if safe_ask "Voulez-vous installer le pare-feu ?"; then
        safe_run yay -S --needed --noconfirm gufw
        safe_run sudo systemctl enable --now ufw.service
    fi
}

main() {
    update_system
    check_grub
    optimize_pacman
    install_kernel_headers
    increase_vm_max_map_count
    install_yay
    configure_maintenance_alias
    install_pipewire
    detect_graphics_card
    install_nvidia_drivers
    install_amd_drivers
    install_intel_drivers
    install_fish_shell
    install_essential_packages
    install_gamepad_drivers
    activate_bluetooth
    install_printer_support
    install_flatpak
    install_misc_software
    install_firewall
    print_step "Le script est terminé. N'oubliez pas de redémarrer votre système."
}

main "$@"
