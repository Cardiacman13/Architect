#!/usr/bin/env bash

sudo -v

GREEN='\e[32m' # Green color
RED='\e[31m'   # Red color
RESET='\e[0m'  # Reset color

source src/setup/graphic_card.sh
source src/setup/packages.sh
source src/setup/peripheries.sh
source src/setup/shell.sh
source src/setup/software.sh
source src/setup/system_setup.sh

function display_progress() {
    local total_tasks=$1
    local completed_tasks=$2
    local start_time=$3

    local current_time=$(date +%s.%N)
    local elapsed_time=$(echo "$current_time - $start_time" | bc)
    local minutes=$(echo "scale=0; $elapsed_time / 60" | bc)
    local seconds=$(echo "scale=0; $elapsed_time % 60" | bc)
    
    local progress=$(echo "scale=0; ($completed_tasks * 100) / $total_tasks" | bc)
    local terminal_width=$(tput cols)
    local bar_length=$(echo "$terminal_width - 20" | bc)
    
    local completed_bar_length=$(echo "scale=0; ($progress * $bar_length) / 100" | bc)
    local uncompleted_bar_length=$(echo "$bar_length - $completed_bar_length" | bc)
    
    local completed_bar=$(printf "%0.s#" $(seq 1 $completed_bar_length))
    local uncompleted_bar=$(printf "%0.s-" $(seq 1 $uncompleted_bar_length))
    
    echo -e "Progress: $completed_tasks/$total_tasks tasks completed."
    echo -e "[${GREEN}${completed_bar}${RED}${uncompleted_bar}${RESET}] $progress% completed."
    echo -e "Elapsed Time: $minutes minutes $seconds seconds."
}

function install_aur_helper() {
    if ! command -v yay &> /dev/null; then
        git clone https://aur.archlinux.org/yay-bin.git
        cd yay-bin
        makepkg -si --noconfirm
        cd ..
        rm -rf yay-bin
    fi
}

function main() {
    local start_time=$(date +%s.%N) 
    local total_tasks=6
    local completed_tasks=0

    if grep -q "^#\[multilib\]" "/etc/pacman.conf"; then
        sudo sed -i '/^#\[multilib\]/,/^#Include = \/etc\/pacman.d\/mirrorlist/ s/^#//' "/etc/pacman.conf"
    fi

    sudo pacman -Syy --noconfirm
    sudo pacman -S --noconfirm git
    install_aur_helper
    yay -S --needed --noconfirm bc lolcat

    display_progress $total_tasks $completed_tasks $start_time
    system_setup            # 1
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time
    install_video_drivers   # 2
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time
    chose_shell             # 3
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time
    install_peripheries     # 4
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time
    install_useful_packages # 5
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time
    install_useful_software # 6
    ((completed_tasks++))
    display_progress $total_tasks $completed_tasks $start_time

    sudo pacman -Rs --noconfirm bc lolcat

    echo "Le système redémarre dans 5 secondes ou appuyez sur Ctrl+C pour annuler."
    TMP=10
    while [[ $TMP -gt 0 ]]; do
        echo -e "${RED}Redémarrage dans ${TMP} secondes...${RESET}"
        sleep 1
        ((TMP--))
    done
    sudo reboot
}

main

